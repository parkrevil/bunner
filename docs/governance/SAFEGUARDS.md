# SAFEGUARDS

## 역할

- 이 문서는 폭주 방지, 대량 수정 제한, 실패/중단/롤백 기준을 정의한다.

## 목적

- 에이전트/자동화가 안전장치를 우회하는 것을 방지한다.
- 실패 시 "어디까지가 허용 가능한가"를 명시해 즉시 중단/롤백을 가능하게 한다.

## 적용 범위

- 문서/코드 변경을 수반하는 모든 자동화 및 에이전트 작업

## 정본/우선순위

- 최상위 정본은 [ARCHITECTURE.md](../../ARCHITECTURE.md)다.

## 관련 문서

- 위반 시 즉시 중단(보안/법적/핵심 불변조건): [POLICY.md](POLICY.md)
- 승인/승격(거버넌스): [GOVERNANCE.md](GOVERNANCE.md)
- 에이전트 집행 규칙: [AGENTS.md](../../AGENTS.md)

## POLICY vs SAFEGUARDS 역할 구분

|            | POLICY                            | SAFEGUARDS (본 문서)        |
| ---------- | --------------------------------- | --------------------------- |
| **트리거** | 단일 위반으로 즉시 발동           | 패턴/반복으로 발동          |
| **관심사** | 절대 금지 (보안/AOT/경계/계약)    | 폭주 방지 (반복/대량 변경)  |
| **예시**   | deep import 1회, reflect-metadata | 동일 구간 3회 수정 반복     |
| **결과**   | 변경 즉시 거부                    | 중단 후 승인 요청 또는 롤백 |

---

## 용어 정의

### Thrashing (스래싱)

동일 파일의 동일 라인 범위(±5줄)에서 **변경→되돌림 사이클이 3회 이상 반복**되는 상태

**판정 기준:**

- 최근 10회 수정 내역에서 동일 구간 왕복이 3회 이상이면 thrashing
- "동일 구간": 시작 라인 기준 ±5줄 범위가 겹치는 경우

**예시:**

```text
1차: 라인 50-60을 A 방식으로 수정
2차: 라인 50-60을 B 방식으로 수정 (실패로 방향 전환)
3차: 라인 50-60을 다시 A 방식으로 수정 ← thrashing 발생
```

**thrashing 발생 시 행동:**

1. 즉시 중단
2. 시도한 접근 방식들 요약
3. 사용자에게 방향 확인 요청

---

## 중단 기준 (즉시 Stop)

### 패턴/반복 기반

| 상황                     | 임계값 | 조치                                       |
| ------------------------ | ------ | ------------------------------------------ |
| 동일 구간 thrashing      | 3회    | 즉시 중단, 방향 확인 요청                  |
| 범위 밖 변경 필요        | 1회    | 승인 요청 ([GOVERNANCE.md](GOVERNANCE.md)) |
| verify 실패 후 해결 불가 | -      | 롤백                                       |

### 규칙 미충족 기반

| 상황                                                      | 관련 SSOT           |
| --------------------------------------------------------- | ------------------- |
| `STYLEGUIDE.md` 클래스 선택 기준(11.2) 미충족 클래스 도입 | STYLEGUIDE.md       |
| `STYLEGUIDE.md` 단일-심볼 파일(16.6) 정당화 없이 추가     | STYLEGUIDE.md       |
| `STRUCTURE.md` `src/common/` 배치 규칙 미충족             | STRUCTURE.md        |
| `DEAD_CODE_POLICY.md` 증명 기록 없이 데드 코드 제거       | DEAD_CODE_POLICY.md |

### 예외: 승인된 범위 확장

아래 조건을 **모두** 만족하면 범위 밖 변경 허용:

1. verify 실패가 범위 밖 파일을 직접 지목
2. 범위 내 수정으로는 해결 불가능
3. 사용자가 **명시적으로 승인**
4. 변경은 **최소 단위**

상세: [AGENTS.md](../../AGENTS.md) 4.1.1 Scope Override Protocol

---

## 대량 변경 제한

| 상황                      | 조치                        |
| ------------------------- | --------------------------- |
| 많은 파일 동시 변경 필요  | 먼저 계획 제시 후 승인 요청 |
| 포맷팅-only 대량 변경     | 사용자 요청 없이는 금지     |
| 리팩토링 + 기능 변경 혼합 | 분리하거나 승인 요청        |

---

## 롤백 기준

| 상황                            | 조치      |
| ------------------------------- | --------- |
| verify 실패 + 범위 내 해결 불가 | 즉시 롤백 |
| Public Facade 계약 깨짐         | 즉시 롤백 |
| 의도치 않은 breaking change     | 즉시 롤백 |

---

## 되돌리기 인식 (Reversibility Awareness)

- 대량/구조적 변경 전에 롤백 가능성을 고려한다.
- 안전한 롤백 전략이 불명확하면 사용자에게 경고 후 확인 요청한다.

---

## 실행 체크리스트

- [ ] 범위 밖 변경이 필요한가? → 즉시 중단, 승인 요청
- [ ] 동일 구간을 3회 이상 수정하고 있는가? → thrashing, 중단
- [ ] 규칙 미충족 상태로 진행하려 하는가? → 중단, 확인 요청
- [ ] 대량 변경인가? → 계획 제시 후 승인 요청
- [ ] 롤백이 필요한 상황인가? → 즉시 롤백
