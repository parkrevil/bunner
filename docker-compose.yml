services:
  postgres-primary:
    image: pgvector/pgvector:0.8.1-pg17
    container_name: postgres-primary
    environment:
      POSTGRES_DB: ${BUNNER_KB_DB:-bunner_kb}
      POSTGRES_USER: ${BUNNER_KB_USER:-postgres}
      POSTGRES_PASSWORD: ${BUNNER_KB_PASSWORD:-postgres}
      POSTGRES_HOST_AUTH_METHOD: ${POSTGRES_HOST_AUTH_METHOD:-trust}
    ports:
      - "${BUNNER_KB_PRIMARY_PORT:-5432}:5432"
    volumes:
      - ./.volumes/postgres/primary:/var/lib/postgresql/data
    command:
      - postgres
      - -c
      - listen_addresses=*
      - -c
      - wal_level=replica
      - -c
      - wal_keep_size=256MB
      - -c
      - max_slot_wal_keep_size=1GB
      - -c
      - max_wal_senders=10
      - -c
      - max_replication_slots=10
      - -c
      - hot_standby=on
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 2s
      timeout: 3s
      retries: 30

  postgres-replica-1:
    image: pgvector/pgvector:0.8.1-pg17
    container_name: postgres-replica-1
    depends_on:
      postgres-primary:
        condition: service_healthy
    environment:
      POSTGRES_DB: ${BUNNER_KB_DB:-bunner_kb}
      POSTGRES_USER: ${BUNNER_KB_USER:-postgres}
      POSTGRES_PASSWORD: ${BUNNER_KB_PASSWORD:-postgres}
      POSTGRES_HOST_AUTH_METHOD: ${POSTGRES_HOST_AUTH_METHOD:-trust}
    ports:
      - "${BUNNER_KB_REPLICA1_PORT:-5433}:5432"
    volumes:
      - ./.volumes/postgres/replica1:/var/lib/postgresql/data
    command:
      - bash
      - -lc
      - |
        set -euo pipefail

        SLOT_NAME='replica_1'
        PRIMARY_HOST='postgres-primary'

        # Ensure the dedicated physical replication slot exists on the primary.
        # This must run even when PGDATA already exists (persistent volume).
        export PGPASSWORD="$$POSTGRES_PASSWORD"
        for i in $(seq 1 60); do
          if /usr/local/bin/gosu postgres psql -h "$$PRIMARY_HOST" -U "$$POSTGRES_USER" -d "$$POSTGRES_DB" -Atqc "select 1 from pg_replication_slots where slot_name='$$SLOT_NAME';" | grep -q '^1$$'; then
            break
          fi

          /usr/local/bin/gosu postgres psql -h "$$PRIMARY_HOST" -U "$$POSTGRES_USER" -d "$$POSTGRES_DB" -v ON_ERROR_STOP=1 \
            -c "select pg_create_physical_replication_slot('$$SLOT_NAME');" \
            || true

          echo "Waiting for primary/slot $$SLOT_NAME... ($$i/60)"
          sleep 1
        done

        /usr/local/bin/gosu postgres psql -h "$$PRIMARY_HOST" -U "$$POSTGRES_USER" -d "$$POSTGRES_DB" -Atqc "select 1 from pg_replication_slots where slot_name='$$SLOT_NAME';" | grep -q '^1$$'

        # Ensure the data directory is writable/readable by the postgres user.
        chown -R postgres:postgres "$$PGDATA" || true
        chmod 700 "$$PGDATA" || true

        if [ ! -s "$$PGDATA/PG_VERSION" ]; then
          rm -rf "$$PGDATA"/*

          until /usr/local/bin/gosu postgres pg_basebackup -h "$$PRIMARY_HOST" -D "$$PGDATA" -U "$$POSTGRES_USER" -Fp -Xs -P -R -S "$$SLOT_NAME"; do
            sleep 1
          done

          chown -R postgres:postgres "$$PGDATA" || true
        fi
        exec /usr/local/bin/gosu postgres /usr/lib/postgresql/17/bin/postgres -c hot_standby=on -c listen_addresses=* -c primary_slot_name=$$SLOT_NAME
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 2s
      timeout: 3s
      retries: 30

  postgres-replica-2:
    image: pgvector/pgvector:0.8.1-pg17
    container_name: postgres-replica-2
    depends_on:
      postgres-primary:
        condition: service_healthy
    environment:
      POSTGRES_DB: ${BUNNER_KB_DB:-bunner_kb}
      POSTGRES_USER: ${BUNNER_KB_USER:-postgres}
      POSTGRES_PASSWORD: ${BUNNER_KB_PASSWORD:-postgres}
      POSTGRES_HOST_AUTH_METHOD: ${POSTGRES_HOST_AUTH_METHOD:-trust}
    ports:
      - "${BUNNER_KB_REPLICA2_PORT:-5434}:5432"
    volumes:
      - ./.volumes/postgres/replica2:/var/lib/postgresql/data
    command:
      - bash
      - -lc
      - |
        set -euo pipefail

        SLOT_NAME='replica_2'
        PRIMARY_HOST='postgres-primary'

        # Ensure the dedicated physical replication slot exists on the primary.
        # This must run even when PGDATA already exists (persistent volume).
        export PGPASSWORD="$$POSTGRES_PASSWORD"
        for i in $(seq 1 60); do
          if /usr/local/bin/gosu postgres psql -h "$$PRIMARY_HOST" -U "$$POSTGRES_USER" -d "$$POSTGRES_DB" -Atqc "select 1 from pg_replication_slots where slot_name='$$SLOT_NAME';" | grep -q '^1$$'; then
            break
          fi

          /usr/local/bin/gosu postgres psql -h "$$PRIMARY_HOST" -U "$$POSTGRES_USER" -d "$$POSTGRES_DB" -v ON_ERROR_STOP=1 \
            -c "select pg_create_physical_replication_slot('$$SLOT_NAME');" \
            || true

          echo "Waiting for primary/slot $$SLOT_NAME... ($$i/60)"
          sleep 1
        done

        /usr/local/bin/gosu postgres psql -h "$$PRIMARY_HOST" -U "$$POSTGRES_USER" -d "$$POSTGRES_DB" -Atqc "select 1 from pg_replication_slots where slot_name='$$SLOT_NAME';" | grep -q '^1$$'

        # Ensure the data directory is writable/readable by the postgres user.
        chown -R postgres:postgres "$$PGDATA" || true
        chmod 700 "$$PGDATA" || true

        if [ ! -s "$$PGDATA/PG_VERSION" ]; then
          rm -rf "$$PGDATA"/*

          until /usr/local/bin/gosu postgres pg_basebackup -h "$$PRIMARY_HOST" -D "$$PGDATA" -U "$$POSTGRES_USER" -Fp -Xs -P -R -S "$$SLOT_NAME"; do
            sleep 1
          done

          chown -R postgres:postgres "$$PGDATA" || true
        fi
        exec /usr/local/bin/gosu postgres /usr/lib/postgresql/17/bin/postgres -c hot_standby=on -c listen_addresses=* -c primary_slot_name=$$SLOT_NAME
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 2s
      timeout: 3s
      retries: 30
