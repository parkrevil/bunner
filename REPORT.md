# Router Review Report

## 평가 기준

- **타당성**: 코드 베이스 전수 확인과 논리 추론으로 재현 가능성이 입증된 경우 `확정`, 환경 의존이 있는 경우 `조건부`, 재현 난도가 있는 경우 `추가 검증 필요`로 표기했습니다.
- **우선순위**: 기능 오류·결정성에 직접 영향이면 `High`, 성능/운영 영향이 중간 수준이면 `Medium`, 명확한 피해는 없지만 개선 가치가 있는 경우 `Low`로 분류했습니다.

## 항목 평가

| #   | 항목                          | 타당성 | 우선순위    | 근거 및 메모                                                                                                                                                                                  |
| --- | ----------------------------- | ------ | ----------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | 파라미터 우선순위 역전        | 확정   | High        | `match-walker.ts`가 패턴 없는 파라미터를 먼저 순회하여 더 구체적인 정규식 파라미터가 영구적으로 가려짐. 동일 경로에 `:id(\d+)`와 `:slug`를 선언하면 `:slug`만 매칭되어 결정성이 깨집니다.     |
| 2   | 정규식 검사 대상 불일치       | 확정   | High        | 정규식 테스트는 raw 세그먼트, 파라미터 저장은 decode된 값으로 동작. `%2F`처럼 디코딩 시 의미가 달라지면 규칙을 우회하거나 불일치가 발생하므로 검증/저장을 동일 값으로 맞춰야 합니다.          |
| 3   | 와일드카드·멀티 파라미터 충돌 | 확정   | Medium-High | `wildcardChild` 하나에 `*`와 `:name+`가 공유되어 첫 선언의 이름만 유지되고 이후 라우트 파라미터명이 소실됩니다. 충돌 검출이나 중복 허용 전략이 필요합니다.                                    |
| 4   | 다중 일반 파라미터 비결정성   | 확정   | High        | 동일 깊이에 `:id`, `:slug` 등 복수 일반 파라미터가 있으면 선언 순서가 우선권을 영구 결정, 후행 라우트는 절대 도달 불가. 최소한 구체성 기반 정렬·경고가 필요합니다.                            |
| 5   | 재귀 기반 탐색 한계           | 확정   | Medium-High | `walk` 재귀가 깊은 경로/복잡한 백트래킹에서 콜스택 위험과 호출 오버헤드를 만듭니다. 반복문+명시적 스택으로 교체 시 안정성과 성능 모두 향상됩니다.                                             |
| 6   | 전체 캐시 무효화              | 확정   | Medium      | 라우트 하나 추가 시 LRU 전체를 비워 재가열 비용이 큼. 동적 라우팅 환경에서 매치 성능이 크게 흔들리므로 부분 무효화 전략이 필요합니다.                                                         |
| 7   | 정적 경로 압축 범위 과대      | 확정   | Medium-Low  | 매번 전체 트리를 재압축하여 라우트 수가 많을수록 삽입 비용이 커집니다. 영향 노드만 재압축하면 등록 성능을 개선할 수 있습니다.                                                                 |
| 8   | 와일드카드 접미사 계산 비용   | 확정   | Low         | `ensureSuffixCache`가 모든 접미사를 누적 문자열로 미리 만들어 O(n^2) 길이 비용을 냅니다. 지연 계산 또는 누적 배열 사용으로 메모리/CPU를 줄일 수 있습니다.                                     |
| 9   | 패턴 테스터 특화 범위 제한    | 조건부 | Low         | `buildPatternTester`가 일부 패턴만 최적화해 빈번한 정규식(예: 고정 길이 숫자 등)에는 여전히 `RegExp.test` 호출이 필요. 성능 민감 서비스라면 추가 패턴을 최적화 후보로 검토할 가치가 있습니다. |
| 10  | 파라미터 이름 중복 허용       | 확정   | Medium      | 서로 다른 세그먼트에서 동일 이름을 쓰면 후행 값이 덮어써져 의도치 않은 결과를 낳습니다. 중복 금지 또는 네임스페이스 정책이 필요합니다.                                                        |
| 11  | 빈 세그먼트 매칭 허용         | 조건부 | Low-Medium  | `collapseSlashes=false`이거나 트레일링 슬래시가 있는 경우 빈 문자열이 파라미터에 할당될 수 있어 입력 검증이 흐려집니다. 옵션화 또는 기본 거부 정책이 필요합니다.                              |
| 12  | 트레일링 슬래시+파라미터 조합 | 조건부 | Low         | 마지막 세그먼트가 파라미터인 경우 `.../` 요청이 빈 값을 허용. 일부 API 계약에서는 허용되지 않아 혼란을 줌. 명시적 정책과 테스트 필요.                                                         |
| 13  | 충돌 검출 공백                | 확정   | Medium      | 기존 와일드카드가 있는 노드에 정적/파라미터를 추가하는 여러 경우가 검출되지 않아 그림자(shadow) 라우트가 생깁니다. 삽입 시 추가 검증 로직이 필요합니다.                                       |
| 14  | 검증/출력 정책 불명확         | 조건부 | Medium-Low  | 디코딩 여부, 파라미터 우선순위 정책이 옵션으로 노출되지 않아 사용자 기대치가 불명확. 설정 노출과 문서화가 필요합니다.                                                                         |
| 15  | 미세 성능 개선 포인트         | 조건부 | Low         | `staticChildren.size` 체크 후 `get`, 파라미터 두 번 순회 등 미세 최적화 여지가 있으나 체감 이득은 낮습니다. 대규모 라우트에서만 유효.                                                         |
| 16  | 사용되지 않는 메타데이터      | 확정   | Low         | `methods.version` 필드가 갱신만 되고 참조되지 않아 불필요한 상태 관리와 혼동을 유발합니다. 제거하거나 활용 방안을 명확히 해야 합니다.                                                         |
| 17  | 책임 과도 집중                | 조건부 | Low-Medium  | `router.ts`가 normalization, caching, compression을 모두 담당해 테스트 단위가 커짐. 모듈 분리 시 유지보수성이 향상될 여지가 큽니다.                                                           |
| 18  | 라딕스 압축 정확성 검증       | 확정   | Low         | `splitStaticChain`, `compressStaticPaths`, `matchStaticParts` 조합이 요구사항대로 삽입/분할/탐색을 처리함을 확인했습니다. 즉각 조치는 없으나 회귀 테스트 대상에 포함하십시오.                 |
| 19  | 라딕스 압축 최적화 한계       | 확정   | Medium      | 압축이 정적 노드에만 적용되고 전체 트리를 지연 압축하여 첫 요청 지연·삽입 비용 증가가 발생합니다. 파라미터 노드 압축 확대와 국소 재압축 전략 도입이 성능을 높일 수 있습니다.                  |

## 요약 권고

1. **필수 조치 (High)**: 항목 1, 2, 4, 5를 우선 해결해 결정성·안정성을 보장하십시오. 필요 시 테스트 케이스를 추가해 회귀를 방지합니다.
2. **권장 조치 (Medium)**: 캐시 무효화, 충돌 검출, 파라미터 이름 정책을 정리해 운영 환경에서의 예측 가능성을 확보하십시오.
3. **선택 개선 (Low)**: 나머지 항목은 성능 목표와 팀 리소스에 맞춰 배치하되, 문서화와 리팩터링 계획에 포함해 두는 것이 좋습니다.

## 단계별 구현 계획

다음 페이즈는 REPORT 항목 #1~#19 전체를 순차적으로 흡수하도록 구성했습니다. 각 단계는 이전 단계 산출물을 전제로 하며, 완료 시점마다 회귀 테스트와 벤치마크를 갱신합니다.

| Phase                         | 목표                       | 포함 항목 (#)               | 선행조건             | 산출물 및 성공 기준                                                                     |
| ----------------------------- | -------------------------- | --------------------------- | -------------------- | --------------------------------------------------------------------------------------- |
| P1. Deterministic Matching    | 결정성/검증 오류 제거      | #1, #2, #4, #10             | P0 테스트·벤치 확보  | 파라미터 우선순위 재정렬, 디코딩 일원화, 파라미터 이름 정책 확립 및 테스트 완료         |
| P2. Matcher Architecture      | 매칭 엔진 안정성·충돌 방지 | #3, #5, #13                 | P1 머지 및 회귀 통과 | 반복문 기반 matcher, 와일드카드/멀티 충돌 검출, 신규 회귀 테스트 + 문서                 |
| P3. Performance & Compression | 성능/자원 사용 개선        | #6, #7, #8, #15, #19        | P2 산출물 안정화     | 부분 캐시 무효화, 국소 압축, 접미사 계산 최적화, 마이크로 최적화 적용 후 벤치 개선 ≥10% |
| P4. Policy & Cleanup          | 장기 유지보수성·정책 정비  | #9, #11, #12, #14, #16, #17 | P3 성능 목표 만족    | 옵션 노출·문서화, 빈 세그먼트 정책, 메타데이터 정리, 모듈 분리 계획 수립                |

### P1. Deterministic Matching

- 파라미터 우선순위 정렬과 정규식 우선 매칭 전략을 정립하고 테스트합니다.
- 패턴 검증/값 디코딩을 동일 단계(디코딩 이후)로 맞추고, 퍼센트-인코딩 우회 케이스 회귀 테스트를 추가합니다.
- 파라미터 이름 중복 정책을 명문화하고, 위반 시 빌드 타임 경고 또는 런타임 오류를 도입합니다.

### P2. Matcher Architecture

- `DynamicMatcher`를 반복문+스택 기반으로 재작성하여 콜스택 리스크를 제거하고, 백트래킹 경로를 명시적으로 관리합니다.
- 와일드카드/멀티 세그먼트 파라미터 등록 시 이름 충돌·섀도잉을 검출하고, 기존 라우트 영향 여부를 테스트합니다.
- 삽입 시 충돌 검출 로직을 강화하고, 새 행동을 README/문서에 기록합니다.

### P3. Performance & Compression

- 라우트 삽입 시 영향을 받는 캐시 키만 무효화하는 역인덱스를 도입합니다.
- 전체-재압축 대신 국소 재압축 알고리즘을 설계하고, 파라미터 노드 압축 가능성까지 탐색합니다.
- 와일드카드 접미사 캐시 계산을 지연 방식으로 최적화하고, 마이크로 최적화(#15)를 함께 적용합니다.
- 벤치마크를 재실행하여 P0 대비 레이턴시 또는 QPS가 목표치(예: ≥10% 향상)를 달성했음을 기록합니다.

### P4. Policy & Cleanup

- 빈 세그먼트, 트레일링 슬래시, 디코딩 정책 등 옵션을 CLI/구성으로 노출하고 문서화합니다.
- 패턴 테스터 확장 범위를 결정하고, 필요 시 사용자 지정 패턴 최적화 훅을 제공합니다.
- 사용되지 않는 메타데이터(`methods.version`)를 제거하거나 용도를 문서화하며, `router.ts` 책임을 하위 모듈로 분리하는 리팩터링을 계획합니다.
